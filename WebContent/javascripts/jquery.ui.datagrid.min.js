/*!
 * jQuery UI datagrid
 * 
 * @autor:.....: Juarez Gon√ßalves Nery Junior
 * @email:.....: juareznjunior@gmail.com
 * @twitter:...: @juareznjunior
 * @date.......: 2013-12-11
 * 
 * Depends:
 *         jquery.ui.core.js
 *         jquery.ui.widget.js
 *         jquery.ui.button.js
 */
;(function(c,q,r,g){var p=Number(c.ui.version.replace(/[^0-9]/g,""));c.widget("ui.datagrid",{options:{limit:20,mapper:[],height:200,jsonStore:{url:"",params:{},data:{}},pagination:!0,refresh:!1,rowNumber:!1,fit:!1,autoRender:!0,autoLoad:!0,ajaxMethod:"GET",title:"",onClickRow:!1,onComplete:!1,onAjaxSuccess:!1,onError:!1,emptyDataMessage:"Empty rows",toolBarButtons:!1},_create:function(){"none"===this.element.css("display")&&this.element.show();var a=[],b;this.uiDataGrid=c('<div class="ui-datagrid-container ui-widget ui-widget-content ui-corner-all"><div class="ui-datagrid-title"><div class="ui-widget-header"></div></div><div class="ui-datagrid-content"><div class="ui-datagrid-content-scroll"><div class="ui-datagrid-header ui-state-default"><table><thead><tr><th><table class="ui-datagrid"><colgroup></colgroup><thead><tr role="rowheader"></tr></thead></table></th><th></th></tr></thead></table></div><div class="ui-widget-content ui-datagrid-body"><table class="ui-datagrid"><colgroup></colgroup><thead><tr role="rowheader"></tr></thead><tbody></tbody></table></div></div></div><div class="ui-widget ui-state-default ui-datagrid-tools"><table class="ui-datagrid"><tbody><tr><td>&nbsp;</td><td style="visibility:hidden"><span></span></td></tr></tbody></table></div></div>');
this.uiDataGrid.find("table").filter(function(){c(this).hasClass("ui-datagrid")?a.push(this):b=this.parentNode.parentNode}).end();""===this.options.title?c(b.parentNode).prev().remove():c(b.parentNode).prev().children().text(this.options.title);!1===c.isArray(this.options.toolBarButtons)&&!1===this.options.pagination&&c(a[2].parentNode).remove();this.uiDataGridThead=c(a[0].tHead);this.uiDataGridTheadBody=c(a[1].tHead);this.uiDataGridColGroup1=this.uiDataGridThead.prev();this.uiDataGridColGroup2=this.uiDataGridTheadBody.prev();
this.uiDataGridTbody=c(a[1].tBodies[0]);this.uiDataGridTfoot=this.options.pagination||c.isArray(this.options.toolBarButtons)?c(a[2].tBodies[0]):c([]);this.uiDataGridScrollBody=c(a[1].parentNode).height(this.options.height);this.uiDataGridScrollMain=c(b);this.uiDataGridTdPagination={childs:[]};this._selectedRows=[];a=b=null;this._totalPages=this._offset=this._num_rows=0;this.element.on("click.uiDataGridBindClick",":data(uiDataGridBindClick)",{uiDataGrid:this},function(a){a.preventDefault();a.stopPropagation();
var b=c.data(this,"uiDataGridBindClick"),e;g!==b&&("loadPage"===b?(e=this.name.split("-").slice(-1),!1===this.disabled&&(c(a.data.uiDataGrid.uiDataGridTdPagination.childs).filter("button").removeClass("ui-state-hover ui-state-focus").button("disable"),a.data.uiDataGrid["_"+e+"Page"](),a.data.uiDataGrid.load())):(e=a.data.uiDataGrid.options,c.map(b.split(":"),function(a,c){e=e[a]}),c.isFunction(e)&&e.call(a.data.uiDataGrid.element[0],this)));b=e=null});this._createPagination()},_init:function(){this.options.autoRender&&
this.render()},_setOption:function(a,b){"jsonStore"===a&&c.isPlainObject(b)?this.options.jsonStore=c.extend({},this.options.jsonStore,b):1.9<=p?this._super(a,b):c.Widget.prototype._setOption.apply(this,arguments)},_destroy:function(){1.9>p&&c.Widget.prototype.destroy.call(this);c.isFunction(this.options.onClickRow)&&this.uiDataGridTbody.off();c.isArray(this.options.toolBarButtons)&&c(this.uiDataGridTfoot[0].rows[0].cells).find("button.ui-button").off();!0===this.options.pagination&&c(this.uiDataGridTfoot[0].rows[0].cells).last().off();
this.element.empty()},_createColumns:function(){var a=this,b=null,f=[],d=[],e=null,h=0,m="<col></col>",n='<th class="ui-widget ui-state-default" role="columnheader"></th>',k="ui-datagrid-align-";c.map(a.options.mapper,function(a,s){e=a.title||a.name;h+=a.width||0;b=c(n).html(e);b=b.text(b.text());b.data("text-align",k+(/left|right|center/.test(a.align)?a.align:"left")).addClass(function(){return c(this).data("textAlign")});g!==a.sort&&b.addClass("ui-datagrid-sort").html(function(){return c("<button>"+
this.innerHTML+"</button>").button({icons:{primary:"",secondary:"ui-icon-carat-2-n-s"}})});d[d.length]=c(m).width(a.width);f[f.length]=b[0];g!==a.hidden&&(b.data("hidden","ui-datagrid-column-hide").addClass("ui-datagrid-column-hide"),c(d).last().addClass("ui-datagrid-column-hide"))});a.options.rowNumber&&(d.splice(0,0,c(m)[0]),f.splice(0,0,c('<th class="ui-state-default ui-datagrid-cell-rownumber" role="columnheader"></th>')[0]),h+=20);c([a.uiDataGridColGroup1[0],a.uiDataGridColGroup2[0]]).empty().append(d.slice(0,
-1));c([a.uiDataGridThead[0].rows[0],a.uiDataGridTheadBody[0].rows[0]]).empty().append(f);c(a.uiDataGridThead[0].rows[0].cells).slice(0,-1).map(function(b,d){d=Math.max(c(d).innerWidth(),c(d).outerWidth());a.uiDataGridColGroup1.children().eq(b).width(d);a.uiDataGridColGroup2.children().eq(b).width(d)});h>a.element.width()&&a.uiDataGridScrollMain.width(h);c(a.uiDataGridTbody[0].parentNode).map(function(b,d){b=c(d.parentNode).find(".ui-datagrid-gridlayout");0<b.length&&b.remove();d=c(d).clone().addClass("ui-datagrid-gridlayout").find("tbody").append('<tr><td class="ui-widget ui-widget-content">&nbsp;'+
Array(d.tHead.rows[0].cells.length).join('</td><td class="ui-widget ui-widget-content">&nbsp;')+"</td></tr>").end().appendTo(d.parentNode);c(d[0].tHead).remove();a.options.rowNumber&&(d[0].tBodies[0].rows[0].cells[0].className="ui-state-default ui-datagrid-cell-rownumber")});c(a.uiDataGridTheadBody[0].parentNode.tHead).hide();f=b=a=m=d=n=k=null},_createRows:function(a,b,f){var d=this,e=d.getThead()[0].rows[0].cells,h=f?d.uiDataGridTbody[0]:d.uiDataGridTbody.empty()[0],m=f?h.rows.length+1:d._offset+
1,n=!f&&"local"===b&&d.options.pagination,k,l;0===d._num_rows&&(d._num_rows=g===a.num_rows?g===a.rows?g===a[0].num_rows?a.length:a[0].num_rows:g===a.rows[0].num_rows?a.rows.length:a.rows[0].num_rows:a.num_rows);a=a.rows||a;n&&1<m&&(a=a.slice(d._offset));c.map(a,function(a,b){if(n&&b===d.options.limit)return!1;k=h.insertRow(-1);k.className="ui-state-hover";c(k).data("row-json",a).data("row-index",m+1);d.options.rowNumber&&c(k.insertCell(0)).addClass("ui-state-default ui-datagrid-cell-rownumber").text(m+
b);c.isFunction(d.options.onClickRow)&&c(k).data("uiDataGridBindClick","onClickRow");c.map(d.options.mapper,function(b,d){l=k.insertCell(-1);l.className="ui-widget ui-widget-content";c.map(c(e[l.cellIndex]).data(),function(a,b){/textAlign|text-align|hidden/.test(b)&&(l.className+=" "+a)});c(l).html(c.isFunction(b.render)?b.render.call(l,a[b.name]):a[b.name])})});f||(this._updatePagination(),d.uiDataGridScrollBody.scrollTop(0));e=h=k=l=d=a=null},_createPagination:function(){if(!0===this.options.pagination){var a=
this,b=c(this.uiDataGridTfoot[0].rows[0].cells).last()[0];a.uiDataGridTdPagination.childs.push(c(b).children()[0]);c.map(["first","prev","next","end"],function(f,d){d=c("<button></button>",{type:"button",name:"uiDataGridSetPage-"+f}).text(f).button({icons:{primary:"ui-icon-seek-"+f},text:!1,disabled:!0}).data("uiDataGridBindClick","loadPage").appendTo(b);a.uiDataGridTdPagination.childs.push(d[0])});b.style.visibility="visible";a=b=null}},_updatePagination:function(){var a,b;this.options.pagination&&
this._num_rows&&(this._totalPages=Math.ceil(this._num_rows/this.options.limit),a=0===this._offset?1:this._offset/this.options.limit+1,b=a+" de "+this._totalPages+" ("+this._num_rows+")",function(f){c.map(f.uiDataGridTdPagination.childs,function(d){/span/i.test(d.tagName)?c(d).text(b):/uiDataGridSetPage-(first|prev)/.test(d.name)?0<f._offset&&d.disabled&&c(d).button("enable"):f._totalPages>a&&d.disabled&&c(d).button("enable")})}(this))},_createToolBarButtons:function(){if(c.isArray(this.options.toolBarButtons)){var a=
this.uiDataGridTfoot[0].rows[0].cells[0];c.map(this.options.toolBarButtons,function(b,f){var d=c("<button></button>",{type:"button"});b.text=b.label||b.text;b.click=b.fn||b.click;delete b.fn;delete b.label;c.isFunction(b.click)&&d.data("uiDataGridBindClick","toolBarButtons:"+f+":click");d.text(b.text).button({icons:{primary:g===b.icon?null:"ui-icon-"+b.icon}}).appendTo(a)});a=null}},_nextPage:function(){this._offset+=this.options.limit},_prevPage:function(){this._offset-=this.options.limit},_endPage:function(){this._offset=
this._totalPages*this.options.limit-this.options.limit},_firstPage:function(){this._offset=0},_active:function(){return this.element.children(":eq(0)").hasClass("ui-datagrid-container")},_getBHF:function(a,b){return c.isFunction(b)?b.call(a[0]):a},_message:function(a){c('<tr><td class="ui-widget ui-datagrid-align-center ui-state-error" colspan="1000">'+a+"</td></tr>").appendTo(this.uiDataGridTbody.empty()[0])},_ajax:function(){var a=this.options,b=a.jsonStore.url,f=a.limit,d=this._offset,e=a.jsonStore;
this.clearSelectedRows();g===b||""===b?(b=(e.data.rows||e.data)[0],g===b||g===b[a.mapper[0].name]?this._message("Invalid JSON or empty data"):this._createRows(e.data,"local"),b=null):("string"===typeof e.params?e.params=0===d?e.params+"&limit="+f+"&offset="+d:e.params.replace(/(&offset=)(.+)/,"&offset="+d):(g===e.params&&(e.params={}),e.params.limit=f,e.params.offset=d),c.ajax({type:a.ajaxMethod.toLowerCase(),url:b.replace(/\?.*/,""),data:e.params,dataType:"json",context:this,success:function(a){if(g!==
a.error||0===a.length)return a=g!==a.error?a.error:0===a.length?this.options.emptyDataMessage:"Invalid JSON",c.isFunction(this.options.onError)?this.options.onError.call(this.element[0],a):this._message(a),!1;this._createRows(a,"ajax");c.isFunction(this.options.onAjaxSuccess)&&this.options.onAjaxSuccess.call(this.element[0])}}))},render:function(){var a=this,b=0;a._active()?(a.resetOffset(),a.load()):(a._createToolBarButtons(),a.uiDataGrid.appendTo(a.element),a._createColumns(),a.resize(),a.options.autoLoad&&
(b=180,setTimeout(function(a){return function(){a.load()}}(a),b)),c.isFunction(a.options.onComplete)&&setTimeout(function(a){return function(){a.options.onComplete.call(a.element[0])}}(a),b++));a=null},resize:function(){this.options.fit&&function(a){a=a.uiDataGrid.outerHeight()-a.element.height();this.style.height=c(this).height()-a+"px"}.call(this.uiDataGridScrollBody[0],this)},selectRow:function(a){var b=c.inArray(a,this._selectedRows);-1<b?(this._selectedRows.splice(b,1),c(a).removeClass("ui-state-highlight")):
(this._selectedRows.push(a),c(a).addClass("ui-state-highlight"))},clearSelectedRows:function(){this.getSelectedRows(!0).removeClass("ui-state-highlight");this._selectedRows=[]},getSelectedRows:function(a){return!0===a?c(this._selectedRows):this._selectedRows},load:function(){this._ajax()},widget:function(){return this.uiDataGrid},getOffset:function(){return this._offset},resetOffset:function(){this._offset=this._num_rows=0;!0===this.options.pagination&&c(this.uiDataGridTdPagination.childs).filter("button").button("disable")},
getThead:function(a){return this._getBHF(this.uiDataGridThead,a)},getTbody:function(a){return this._getBHF(this.uiDataGridTbody,a)},getTFoot:function(a){return this._getBHF(this.uiDataGridTfoot,a)},addRow:function(a){this._createRows(a,null,!0)},loadLocalData:function(a,b){this.resetOffset();this.options.jsonStore={url:"",params:{},data:a};this.load();c.isFunction(b)&&b.call([])},updateColumns:function(a){this.options.mapper=a;this.uiDataGridTbody.empty();this._createColumns();this.resetOffset()}})})(jQuery,
window,document);